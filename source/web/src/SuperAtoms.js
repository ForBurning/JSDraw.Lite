//////////////////////////////////////////////////////////////////////////////////
//
// JSDraw.Lite
// Copyright (C) 2018 Scilligence Corporation
// http://www.scilligence.com/
//
// (Released under LGPL 3.0: https://opensource.org/licenses/LGPL-3.0)
//
//////////////////////////////////////////////////////////////////////////////////

JSDraw2.SuperAtoms = {
    sdf: "\nMolEngine02241412152D\n\n  6  6  0  0  0  0            999 V2000\n    1.3510    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3510    3.1200    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0  0  0  0\n  2  3  1  0  0  0  0\n  1  4  1  0  0  0  0\n  4  5  2  0  0  0  0\n  5  6  1  0  0  0  0\n  6  3  2  0  0  0  0\nM  END\n> <T>\nBenzene\n\n$$$$\n\nMolEngine02241412152D\n\n  6  6  0  0  0  0            999 V2000\n    1.3510    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3510    3.1200    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  1  0  0  0  0\n  6  1  1  0  0  0  0\nM  END\n> <T>\nHexane\n\n$$$$\n\nMolEngine02241412152D\n\n  5  5  0  0  0  0            999 V2000\n    0.0000    0.4821    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.4836    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.4006    1.2621    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.4836    2.5242    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.0421    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  1  1  0  0  0  0\nM  END\n> <T>\nPentane\n\n$$$$\n\nMolEngine02241412152D\n\n  3  3  0  0  0  0            999 V2000\n    0.7800    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    1.3510    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5600    1.3510    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  1  3  1  0  0  0  0\n  2  3  1  0  0  0  0\nM  END\n> <T>\nPropane\n\n$$$$\n\nMolEngine02241412152D\n\n  4  4  0  0  0  0            999 V2000\n    0.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    1.5600    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5600    1.5600    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5600    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  1  1  0  0  0  0\nM  END\n> <T>\nButane\n\n$$$$\n\nMolEngine02241412152D\n\n  7  7  0  0  0  0            999 V2000\n    0.0000    0.9727    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2196    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7405    0.3471    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.4174    1.7527    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7405    3.1581    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2196    3.5054    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.5327    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  1  0  0  0  0\n  6  7  1  0  0  0  0\n  7  1  1  0  0  0  0\nM  END\n> <T>\nHeptane\n\n$$$$\n\nMolEngine02241412152D\n\n  8  8  0  0  0  0            999 V2000\n    0.0000    1.1031    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.1031    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6631    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.7660    1.1031    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.7660    2.6631    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6631    3.7662    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.1031    3.7662    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.6631    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  1  0  0  0  0\n  6  7  1  0  0  0  0\n  7  8  1  0  0  0  0\n  8  1  1  0  0  0  0\nM  END\n> <T>\nOctane\n\n$$$$\n",

    dict: null,
    reversible: {},
    AminoAcids: {},
    DNAs: {},
    RNAs: {},
    templates: {},
    nterminals: {},
    cterminals: {},
    customtemplates: {},

    listFunctionalGroups: function (parent) {
        this.read();
        var cols = [{ key: 'name', caption: 'Name', width: 200 }, { key: 'molfile', type: "structure", caption: 'Structure'}];
        var jss = new JSDraw2.Table(null, { columns: cols, toolbar: ["search"] }, parent);

        var list = [];
        for (var name in this.dict)
            list.push({ name: name, molfile: this.dict[name] == null ? null : this.dict[name].getMolfile() });
        jss.setJson({ rows: list });

    },

    filter: function (q, n) {
        if (q == null || q == "")
            return null;

        var ret = [];
        q = q.toLowerCase();
        var len = q.length;
        for (var k in this.dict) {
            if (k.length >= len && k.substr(0, len).toLowerCase() == q) {
                ret.push(k);
                if (ret.length >= n)
                    break;
            }
        }
        return ret;
    },

    get: function (name) {
        this.read();
        var m = this.dict[name];
        if (m == null)
            m = this.nterminals[name];
        if (m == null)
            m = this.cterminals[name];
        return m == null ? null : m.clone();
    },

    getDNA: function (name) {
        this.read();
        return this.DNAs[name];
    },

    getRNA: function (name) {
        this.read();
        return this.RNAs[name];
    },

    getAA: function (name) {
        this.read();
        return this.AminoAcids[name];
    },

    getTemplate: function (name) {
        this.read();
        return this.templates[name];
    },

    hasCustomTemplates: function (name) {
        this.read();
        for (var k in this.customtemplates)
            return true;
        return false;
    },

    getCustomTemplate: function (name) {
        this.read();
        return this.customtemplates[name];
    },

    // COOH --> HOOC, CO2H --> HO2C, n-But --> n-But, Boc --> Boc
    reverseLabel: function (s) {
        this.read();
        if (this.get(s) != null)
            return this.reverseLabel2(s);

        var c = s.substr(0, 1);
        var s1 = s.substr(1);
        if ((c == "O" || c == "S") && this.get(s1) != null)
            return this.reverseLabel2(s1) + c;

        return s;
    },

    reverseLabel2: function (s) {
        if (this.reversible[s] == null)
            return s;

        var ret = "";
        for (var i = s.length - 1; i >= 0; --i) {
            var n = 1;
            for (var j = i; j >= 0; --j) {
                var c = s.charCodeAt(j);
                if (c >= 65 && c <= 90)
                    break;
                else
                    ++n;
            }
            i -= n - 1;
            ret += s.substr(i, n);
        }
        return ret;
    },

    guessOne: function (name) {
        this.read();

        name = name.toLowerCase();
        for (var k in this.dict) {
            if (k.toLowerCase() == name)
                return k;
        }

        return null;
    },

    read: function () {
        if (this.dict != null)
            return;
        this.dict = {};
        this.addSdf(this.sdf);

        if (JSDraw2.defaultoptions != null)
            this.addSdf(JSDraw2.defaultoptions.abbreviations);
        this.addSdf(JSDraw2.abbreviations);

        if (this.onAfterRead != null)
            this.onAfterRead();
    },

    addSdf: function (sdf) {
        if (sdf == null || sdf == "")
            return;

        var unknown = 0;
        var ss = sdf.split("$$$$");
        for (var k = 0; k < ss.length; ++k) {
            var r = JSDraw2.Table.readSdfRecord(ss[k], true);
            if (r == null)
                break;

            var template = r.props["T"];
            var customtemplate = r.props["CT"];
            var strname = r.props["Name"];
            var m = new JSDraw2.Mol();
            m.setMolfile(r.molfile);
            //this.normalize(m);
            if (template != null) {
                this.templates[template] = m;
            }
            else if (customtemplate != null) {
                this.customtemplates[customtemplate] = m;
            }
        }
    },

    _getAttachAtoms: function (m) {
        var list = [];
        if (m != null) {
            for (var i = 0; i < m.atoms.length; ++i) {
                var a = m.atoms[i];
                for (var k = 0; k < a.attachpoints.length; ++k)
                    list[a.attachpoints[k] - 1] = { apo: a.attachpoints[k], a: a };
            }
        }
        return list;
    },

    _alignMol: function (dest, a, src, a0, len) {
        if (len > 0)
            src.setBondLength(len);

        var bonds = dest.getNeighborBonds(a);
        if (bonds.length == 0) {
            src.offset(a.p.x - a0.p.x, a.p.y - a0.p.y);
        }
        else if (bonds.length == 1) {
            // offset to reference atom
            src.offset(a.p.x - a0.p.x, a.p.y - a0.p.y);

            b = bonds[0];
            // rotate to the reversed direction
            var deg = b.otherAtom(a).p.angleTo(a.p);
            var bs = src.getNeighborBonds(a0);
            if (bs.length == 1)
                src.rotate(a.p, deg + 60 - a0.p.angleTo(bs[0].otherAtom(a0).p));
            else if (bs.length == 2)
                src.rotate(a.p, deg + 180 - a0.p.middleAngle(bs[0].otherAtom(a0).p, bs[1].otherAtom(a0).p));
        }
        else if (bonds.length == 2) {
            // offset to reference atom
            src.offset(a.p.x - a0.p.x, a.p.y - a0.p.y);

            // rotate to the reversed direction
            var deg = a.p.middleAngle(bonds[0].otherAtom(a).p, bonds[1].otherAtom(a).p);
            var bs = src.getNeighborBonds(a0);
            if (bs.length == 1)
                src.rotate(a.p, deg + 60 - a0.p.angleTo(bs[0].otherAtom(a0).p));
            else if (bs.length == 2)
                src.rotate(a.p, deg + 180 - a0.p.middleAngle(bs[0].otherAtom(a0).p, bs[1].otherAtom(a0).p));
        }
        else {
            return false;
        }

        return true;
    }
};

